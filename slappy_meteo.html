<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SLAPPY ‚Äî Meteo</title>
    <style>
        :root {
            --font-system: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --radius-card: 16px;
            --radius-small: 12px;
            --bg: #f5f5f5;
            --white: #ffffff;
            --text-dark: #1a1a1a;
            --text-medium: #555555;
            --text-light: #888888;
            --teal: #2a9d8f;
            --teal-light: #b2dfdb;
            --teal-border: #b2dfdb;
            --blue-light: #b3e5fc;
            --blue-border: #bbdefb;
            --green-light: #c8e6c9;
            --green-border: #c8e6c9;
            --yellow-light: #fff59d;
            --yellow-border: #fff9c4;
            --red-light: #ffcdd2;
            --red-border: #ffcdd2;
            --purple-light: #e1bee7;
            --purple-border: #e1bee7;
            --orange-light: #ffcc80;
            --orange-border: #ffe0b2;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-900: #111827;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            font-family: var(--font-system);
            background: var(--bg);
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
        }
        .app {
            width: 100%;
            max-width: 480px;
            min-height: 100vh;
            margin: 0 auto;
            background: var(--bg);
            overflow-y: auto;
            position: relative;
        }
        @media (min-width: 481px) {
            body { display: flex; justify-content: center; background: #e8e8e8; }
            .app { box-shadow: 0 0 60px rgba(0,0,0,0.1); }
        }

        /* HEADER */
        .header {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            background: radial-gradient(ellipse at center, var(--white) 0%, var(--teal-light) 100%);
            gap: 12px;
        }
        .header-back {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
            cursor: pointer;
            border: none;
            color: var(--text-dark);
            font-size: 18px;
            text-decoration: none;
        }
        .header-content { flex: 1; }
        .header-title { font-size: 17px; font-weight: 700; color: var(--text-dark); }
        .header-subtitle { font-size: 12px; color: rgba(0,0,0,0.7); margin-top: 2px; }

        /* MAIN */
        .main {
            padding: 16px;
            padding-bottom: 100px;
        }

        /* SECTION */
        .section-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            margin-top: 20px;
            border-left: 4px solid #b2dfdb;
            padding-left: 12px;
        }
        .section-title:first-child { margin-top: 0; }

        /* LOADING */
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }
        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid var(--gray-200);
            border-top-color: var(--teal);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* INFO CARD - GIALLO (meteo principale) */
        .info-card {
            background: radial-gradient(ellipse at center, #fff8e1 0%, #ffecb3 100%);
            border: 1px solid #ffe082;
            border-radius: var(--radius-card);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .info-card.yellow {
            background: radial-gradient(ellipse at center, #fff8e1 0%, #ffecb3 100%);
            border-color: #ffe082;
        }
        .info-card.red {
            background: radial-gradient(ellipse at center, var(--white) 0%, var(--red-light) 100%);
            border-color: var(--red-border);
        }
        .info-row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }
        .info-item {
            text-align: center;
            flex: 1;
        }
        .info-item-icon-wrapper {
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 6px;
            gap: 8px;
        }
        .info-item-icon {
            font-size: 20px;
        }
        .info-item-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }
        .info-item-dot.green { background: #4ade80; box-shadow: 0 0 8px rgba(74, 222, 128, 0.6); }
        .info-item-dot.yellow { background: #facc15; box-shadow: 0 0 8px rgba(250, 204, 21, 0.6); }
        .info-item-dot.red { background: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.6); }
        .info-item-value {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-dark);
        }
        .info-item-label {
            font-size: 9px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }
        .info-divider {
            width: 1px;
            height: 50px;
            background: rgba(0,0,0,0.08);
            margin-top: 4px;
        }

        /* BOX DETTAGLI COMPATTO - VERDE ACQUA MEDIO */
        .meteo-details {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            background: radial-gradient(ellipse at center, #b2dfdb 0%, #80cbc4 100%);
            border: 1px solid #4db6ac;
            border-radius: var(--radius-card);
            padding: 14px 16px;
            margin-bottom: 16px;
        }
        .meteo-detail-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: var(--text-medium);
        }
        .meteo-detail-icon { font-size: 14px; }
        .meteo-detail-value { font-weight: 600; color: var(--text-dark); }
        .meteo-detail-divider { color: rgba(0,0,0,0.15); }

        /* BOX CONSIGLIO */
        .advice-box {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-card);
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .advice-box.warning {
            background: linear-gradient(180deg, #fff8e1 0%, #ffecb3 100%);
            border-color: #ffe082;
        }
        .advice-box.danger {
            background: linear-gradient(180deg, #ffebee 0%, #ffcdd2 100%);
            border-color: #ef9a9a;
        }
        .advice-box-icon { font-size: 32px; flex-shrink: 0; }
        .advice-box-content { flex: 1; }
        .advice-box-title { font-size: 14px; font-weight: 700; color: var(--text-dark); }
        .advice-box-desc { font-size: 12px; color: var(--text-medium); margin-top: 2px; }

        /* DETTAGLI GRID */
        .details-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-card);
            padding: 16px 12px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .details-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px 8px;
        }
        .detail-item {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        .detail-icon {
            font-size: 22px;
            margin-bottom: 6px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .detail-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-dark);
            line-height: 1.2;
        }
        .detail-label { font-size: 10px; color: var(--text-light); text-transform: uppercase; margin-top: 2px; }

        /* MAREE CARD - VERDE ACQUA CHIARO */
        .maree-card {
            background: radial-gradient(ellipse at center, #e0f2f1 0%, #b2dfdb 100%);
            border: 1px solid #80cbc4;
            border-radius: var(--radius-card);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .maree-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .maree-title-icon { font-size: 20px; }
        .maree-boxes {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        .maree-box {
            border-radius: 12px;
            padding: 10px 6px;
            text-align: center;
        }
        .maree-box.alta {
            background: #b2dfdb;
            border: 1px solid #80cbc4;
        }
        .maree-box.bassa {
            background: #e0f2f1;
            border: 1px solid #b2dfdb;
        }
        .maree-box.next {
            border: 2px solid var(--teal);
            box-shadow: 0 0 8px rgba(42,157,143,0.3);
        }
        .maree-box-time { font-size: 13px; font-weight: 700; color: var(--text-dark); }
        .maree-box-level { font-size: 11px; color: var(--text-medium); margin-top: 2px; }
        .maree-box-type { font-size: 10px; font-weight: 600; margin-top: 4px; }
        .maree-box-type.alta { color: #16a34a; }
        .maree-box-type.bassa { color: #1565c0; }

        /* GRAFICO MAREE */
        .maree-graph {
            height: 50px;
            background: linear-gradient(to bottom, rgba(42,157,143,0.05) 0%, rgba(42,157,143,0.1) 100%);
            border-radius: 10px;
            position: relative;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .maree-curve {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100%;
        }
        .maree-curve svg {
            width: 100%;
            height: 100%;
        }
        .maree-curve svg path.wave-line {
            animation: waveFloat 2.5s ease-in-out infinite;
        }
        .maree-curve svg path.wave-fill {
            animation: waveFloat 2.5s ease-in-out infinite;
        }
        @keyframes waveFloat {
            0% { transform: translateX(0) translateY(0); }
            25% { transform: translateX(-1px) translateY(-2px); }
            50% { transform: translateX(0) translateY(-3px); }
            75% { transform: translateX(1px) translateY(-2px); }
            100% { transform: translateX(0) translateY(0); }
        }
        .maree-now-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #f59e0b;
            z-index: 2;
        }
        .maree-now-marker::before {
            content: 'ORA';
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8px;
            font-weight: 700;
            color: #f59e0b;
            background: var(--white);
            padding: 2px 4px;
            border-radius: 4px;
        }
        .maree-next-box {
            background: rgba(42,157,143,0.1);
            border: 1px solid rgba(42,157,143,0.3);
            border-radius: 10px;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .maree-next-icon { font-size: 14px; }
        .maree-next-text { flex: 1; }
        .maree-next-label { font-size: 11px; color: var(--text-light); }
        .maree-next-value { font-size: 14px; font-weight: 700; color: #1a7a70; }

        /* MAREE CARD CLICCABILE */
        .maree-card {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .maree-card:active {
            transform: scale(0.98);
        }
        .maree-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .maree-expand-hint {
            font-size: 11px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .maree-expand-hint span {
            font-size: 16px;
        }

        /* MODAL MAREE SETTIMANALI */
        .maree-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: flex-end;
            padding: 20px;
        }
        .maree-modal-overlay.active {
            display: flex;
        }
        .maree-modal {
            background: var(--white);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 480px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .maree-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            background: var(--white);
            z-index: 1;
        }
        .maree-modal-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-dark);
        }
        .maree-modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gray-100);
            border: none;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .maree-modal-content {
            padding: 16px 20px 20px;
        }
        .maree-day-section {
            margin-bottom: 16px;
        }
        .maree-day-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--gray-200);
        }
        .maree-day-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }
        .maree-day-item {
            border-radius: 8px;
            padding: 8px 4px;
            text-align: center;
        }
        .maree-day-item.alta {
            background: #b2dfdb;
            border: 1px solid #80cbc4;
        }
        .maree-day-item.bassa {
            background: #e0f2f1;
            border: 1px solid #b2dfdb;
        }
        .maree-day-item-time {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-dark);
        }
        .maree-day-item-level {
            font-size: 10px;
            color: var(--text-medium);
            margin-top: 2px;
        }
        .maree-day-item-type {
            font-size: 9px;
            font-weight: 600;
            margin-top: 3px;
        }
        .maree-day-item-type.alta { color: #16a34a; }
        .maree-day-item-type.bassa { color: #1565c0; }

        /* FORECAST SCROLL CONTAINER */
        .forecast-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 4px 0 16px 0;
            margin: 0 -16px;
            padding-left: 16px;
            padding-right: 16px;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }
        .forecast-scroll::-webkit-scrollbar {
            display: none;
        }
        .forecast-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* FORECAST CARDS - stile compatto per scroll */
        .forecast-card {
            flex: 0 0 auto;
            width: 100px;
            border-radius: var(--radius-card);
            padding: 14px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            cursor: pointer;
            transition: transform 0.2s;
            scroll-snap-align: start;
        }
        .forecast-card:active {
            transform: scale(0.96);
        }

        /* SFONDI FORECAST CARD BASATI SUL METEO */
        .forecast-card.weather-sereno {
            background: linear-gradient(180deg, #fffde7 0%, #fff9c4 100%);
            border: 1px solid #fff59d;
        }
        .forecast-card.weather-parziale {
            background: linear-gradient(180deg, #fffde7 0%, #f5f5f5 100%);
            border: 1px solid #e0e0e0;
        }
        .forecast-card.weather-nuvoloso {
            background: linear-gradient(180deg, #fafafa 0%, #eeeeee 100%);
            border: 1px solid #e0e0e0;
        }
        .forecast-card.weather-pioggia {
            background: linear-gradient(180deg, #e3f2fd 0%, #bbdefb 100%);
            border: 1px solid #90caf9;
        }
        .forecast-card.weather-temporale {
            background: linear-gradient(180deg, #ede7f6 0%, #d1c4e9 100%);
            border: 1px solid #b39ddb;
        }
        .forecast-card.weather-neve {
            background: linear-gradient(180deg, #fafafa 0%, #e8f5e9 100%);
            border: 1px solid #c8e6c9;
        }

        /* Elementi card compatta */
        .forecast-card .forecast-day-name {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-dark);
        }
        .forecast-card .forecast-icon {
            font-size: 32px;
            width: auto;
        }
        .forecast-card .forecast-temps-compact {
            text-align: center;
        }
        .forecast-card .forecast-temp-max {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-dark);
        }
        .forecast-card .forecast-temp-min {
            font-size: 13px;
            color: var(--text-light);
        }
        .forecast-card .forecast-sea {
            font-size: 10px;
            color: var(--text-medium);
            display: flex;
            align-items: center;
            gap: 3px;
        }

        /* MODAL DETTAGLIO GIORNO */
        .day-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: flex-end;
        }
        .day-modal-overlay.active {
            display: flex;
        }
        .day-modal {
            background: var(--white);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 480px;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }
        .day-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            background: var(--white);
            z-index: 1;
        }
        .day-modal-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-dark);
        }
        .day-modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gray-100);
            border: none;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .day-modal-content {
            padding: 16px 20px 20px;
        }
        .day-modal-hero {
            text-align: center;
            padding: 16px 0 20px;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 16px;
        }
        .day-modal-icon { font-size: 48px; margin-bottom: 8px; }
        .day-modal-temp { font-size: 36px; font-weight: 700; color: var(--text-dark); }
        .day-modal-condition { font-size: 14px; color: var(--text-medium); margin-top: 4px; }
        .day-modal-section {
            margin-bottom: 16px;
        }
        .day-modal-section-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        /* BARRE DETTAGLI MODAL (stile header verde) */
        .day-modal-details-bar {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            background: radial-gradient(ellipse at center, var(--white) 0%, var(--teal-light) 100%);
            border: 1px solid var(--teal-border);
            border-radius: var(--radius-card);
            padding: 14px 16px;
            margin-bottom: 10px;
        }
        .day-modal-details-bar:last-child {
            margin-bottom: 0;
        }
        .day-modal-detail-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: var(--text-medium);
        }
        .day-modal-detail-icon { font-size: 14px; }
        .day-modal-detail-value { font-weight: 600; color: var(--text-dark); }
        .day-modal-detail-divider { color: rgba(0,0,0,0.15); }
        .flag-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 4px rgba(0,0,0,0.2);
        }

        /* MAREE MODAL (stile verde acqua come pagina principale) */
        .day-modal-tides-container {
            background: radial-gradient(ellipse at center, var(--white) 0%, var(--teal-light) 100%);
            border: 1px solid var(--teal-border);
            border-radius: var(--radius-card);
            padding: 14px;
        }
        .day-modal-tides {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .day-modal-tide {
            border-radius: 12px;
            padding: 10px 6px;
            text-align: center;
        }
        .day-modal-tide.alta {
            background: #b2dfdb;
            border: 1px solid #80cbc4;
        }
        .day-modal-tide.bassa {
            background: #e0f2f1;
            border: 1px solid #b2dfdb;
        }
        .day-modal-tide-time { font-size: 13px; font-weight: 700; color: var(--text-dark); }
        .day-modal-tide-level { font-size: 11px; color: var(--text-medium); margin-top: 2px; }
        .day-modal-tide-type { font-size: 10px; font-weight: 600; margin-top: 4px; }
        .day-modal-tide-type.alta { color: #16a34a; }
        .day-modal-tide-type.bassa { color: #1565c0; }

        /* ORARI GIORNO */
        .day-modal-hours {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 4px;
            -webkit-overflow-scrolling: touch;
        }
        .day-modal-hours::-webkit-scrollbar {
            display: none;
        }
        .day-modal-hours {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .day-modal-hour {
            flex: 0 0 auto;
            width: 58px;
            border-radius: 12px;
            padding: 10px 6px;
            text-align: center;
        }
        .day-modal-hour-time {
            font-size: 10px;
            color: var(--text-medium);
            font-weight: 600;
            margin-bottom: 4px;
        }
        .day-modal-hour-icon {
            font-size: 20px;
            margin-bottom: 2px;
        }
        .day-modal-hour-temp {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-dark);
        }

        /* BOX DATI FISSI */
        .static-data-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-card);
            padding: 16px;
            margin-top: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .static-data-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-light);
            text-transform: uppercase;
            margin-bottom: 12px;
        }
        .static-data-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .static-data-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .static-data-icon {
            font-size: 20px;
        }
        .static-data-text {
            flex: 1;
        }
        .static-data-label {
            font-size: 11px;
            color: var(--text-light);
        }
        .static-data-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-dark);
        }
        .day-modal-advice {
            background: var(--gray-100);
            border-radius: 12px;
            padding: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .day-modal-advice-icon { font-size: 24px; }
        .day-modal-advice-text { flex: 1; }
        .day-modal-advice-title { font-size: 13px; font-weight: 700; color: var(--text-dark); }
        .day-modal-advice-desc { font-size: 11px; color: var(--text-medium); margin-top: 2px; }
        .forecast-day {
            width: 44px;
            text-align: center;
        }
        .forecast-day-name { font-size: 13px; font-weight: 700; color: var(--text-dark); }
        .forecast-day-num { font-size: 10px; color: var(--text-light); }
        .forecast-icon { font-size: 36px; width: 44px; text-align: center; }
        .forecast-temps {
            flex: 1;
            min-width: 0;
        }
        .forecast-temp-row {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-dark);
        }
        .forecast-temp-min { font-weight: 400; color: var(--text-light); font-size: 14px; }
        .forecast-details {
            display: flex;
            gap: 10px;
            margin-top: 4px;
        }
        .forecast-detail {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 11px;
            color: var(--text-medium);
        }
        .forecast-detail-icon { font-size: 12px; }

        /* TIP CARD */
        .tip-card {
            background: radial-gradient(ellipse at center, var(--white) 0%, var(--green-light) 100%);
            border: 1px solid var(--green-border);
            border-radius: var(--radius-card);
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            text-decoration: none;
            transition: transform 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .tip-card:active { transform: scale(0.98); }
        .tip-icon {
            width: 44px;
            height: 44px;
            background: #22c55e;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }
        .tip-content { flex: 1; }
        .tip-title { font-size: 14px; font-weight: 700; color: #166534; }
        .tip-desc { font-size: 12px; color: #15803d; margin-top: 2px; }
        .tip-arrow { font-size: 20px; color: #166534; }

        /* LEGENDA */
        .legenda-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-card);
            padding: 14px 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .legenda-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-light);
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        .legenda-items {
            display: flex;
            justify-content: space-around;
        }
        .legenda-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-medium);
        }
        .legenda-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .legenda-dot.green { background: #4ade80; }
        .legenda-dot.yellow { background: #facc15; }
        .legenda-dot.red { background: #ef4444; }

        /* TAB BAR MINIMAL */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            background: #f8f9fa;
            padding: 8px 16px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            display: flex;
            justify-content: space-around;
            border-top: 1px solid #e0e0e0;
            z-index: 1000;
        }
        .tab-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 6px 16px;
            cursor: pointer;
            text-decoration: none;
            position: relative;
            background: none;
            border: none;
        }
        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 3px;
            border-radius: 2px;
            background: transparent;
            transition: background 0.2s;
        }
        .tab-btn:active { opacity: 0.7; }
        .tab-btn-icon {
            font-size: 24px;
            filter: grayscale(100%);
            opacity: 0.5;
            transition: all 0.2s;
        }
        .tab-btn-label {
            font-size: 11px;
            font-weight: 500;
            color: #888888;
            transition: color 0.2s;
        }
        .tab-btn.active .tab-btn-icon { filter: grayscale(0%); opacity: 1; }
        .tab-btn.active .tab-btn-label { color: var(--text-dark); font-weight: 600; }
        .tab-btn.home.active::after { background: #78909c; }
        .tab-btn.meteo.active::after { background: #2a9d8f; }
        .tab-btn.esplora.active::after { background: #8d6e63; }
        .tab-btn.trasporti.active::after { background: #42a5f5; }
        .tab-btn.sos.active::after { background: #ef5350; }
    </style>
</head>
<body>
<div class="app">
    <header class="header">
        <a href="index.html" class="header-back">‚Üê</a>
        <div class="header-content">
            <div class="header-title">Meteo</div>
            <div class="header-subtitle">Cavallino-Treporti</div>
        </div>
    </header>

    <main class="main" id="mainContent">
        <div class="loading">
            <div class="loading-spinner"></div>
            <p style="margin-top: 12px;">Caricamento dati meteo...</p>
        </div>
    </main>

    <nav class="tab-bar">
        <a href="index.html" class="tab-btn home">
            <span class="tab-btn-icon">üè†</span>
            <span class="tab-btn-label">Home</span>
        </a>
        <a href="slappy_meteo.html" class="tab-btn meteo active">
            <span class="tab-btn-icon">‚òÄÔ∏è</span>
            <span class="tab-btn-label">Meteo</span>
        </a>
        <a href="slappy_home.html#esplora-section" class="tab-btn esplora">
            <span class="tab-btn-icon">üß≠</span>
            <span class="tab-btn-label">Esplora</span>
        </a>
        <a href="slappy_trasporti.html" class="tab-btn trasporti">
            <span class="tab-btn-icon">üöå</span>
            <span class="tab-btn-label">Trasporti</span>
        </a>
        <a href="slappy_sos.html" class="tab-btn sos">
            <span class="tab-btn-icon">üÜò</span>
            <span class="tab-btn-label">SOS</span>
        </a>
    </nav>
</div>

<script>
const weatherCodes = {
    0: { icon: '‚òÄÔ∏è', desc: 'Sereno' },
    1: { icon: 'üå§Ô∏è', desc: 'Prev. sereno' },
    2: { icon: '‚õÖ', desc: 'Parz. nuvoloso' },
    3: { icon: '‚òÅÔ∏è', desc: 'Nuvoloso' },
    45: { icon: 'üå´Ô∏è', desc: 'Nebbia' },
    48: { icon: 'üå´Ô∏è', desc: 'Nebbia gelata' },
    51: { icon: 'üå¶Ô∏è', desc: 'Pioggerella' },
    53: { icon: 'üå¶Ô∏è', desc: 'Pioggerella' },
    55: { icon: 'üå¶Ô∏è', desc: 'Pioggerella' },
    61: { icon: 'üåßÔ∏è', desc: 'Pioggia leggera' },
    63: { icon: 'üåßÔ∏è', desc: 'Pioggia' },
    65: { icon: 'üåßÔ∏è', desc: 'Pioggia forte' },
    71: { icon: 'üå®Ô∏è', desc: 'Neve leggera' },
    73: { icon: 'üå®Ô∏è', desc: 'Neve' },
    75: { icon: 'üå®Ô∏è', desc: 'Neve forte' },
    80: { icon: 'üå¶Ô∏è', desc: 'Rovesci' },
    81: { icon: 'üåßÔ∏è', desc: 'Rovesci' },
    82: { icon: '‚õàÔ∏è', desc: 'Temporale' },
    95: { icon: '‚õàÔ∏è', desc: 'Temporale' },
    96: { icon: '‚õàÔ∏è', desc: 'Temporale grandine' },
    99: { icon: '‚õàÔ∏è', desc: 'Temporale grandine' }
};

const dayNames = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
const dayNamesFull = ['Domenica', 'Lunedi', 'Martedi', 'Mercoledi', 'Giovedi', 'Venerdi', 'Sabato'];
const monthNames = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];

// Maree giornaliere Punta Sabbioni (4 maree tipiche)
const tidesData = [
    { time: '06:42', level: '+12', type: 'bassa' },
    { time: '12:58', level: '+87', type: 'alta' },
    { time: '19:15', level: '-8', type: 'bassa' },
    { time: '01:24', level: '+72', type: 'alta' }
];

// Maree settimanali (simulate - in produzione usare API reale)
const weeklyTidesData = [
    { day: 0, tides: [{ time: '06:42', level: '+12', type: 'bassa' }, { time: '12:58', level: '+87', type: 'alta' }, { time: '19:15', level: '-8', type: 'bassa' }, { time: '01:24', level: '+72', type: 'alta' }] },
    { day: 1, tides: [{ time: '07:18', level: '+8', type: 'bassa' }, { time: '13:35', level: '+92', type: 'alta' }, { time: '19:52', level: '-12', type: 'bassa' }, { time: '02:01', level: '+68', type: 'alta' }] },
    { day: 2, tides: [{ time: '07:55', level: '+5', type: 'bassa' }, { time: '14:12', level: '+95', type: 'alta' }, { time: '20:30', level: '-15', type: 'bassa' }, { time: '02:38', level: '+65', type: 'alta' }] },
    { day: 3, tides: [{ time: '08:32', level: '+3', type: 'bassa' }, { time: '14:50', level: '+98', type: 'alta' }, { time: '21:08', level: '-18', type: 'bassa' }, { time: '03:15', level: '+62', type: 'alta' }] },
    { day: 4, tides: [{ time: '09:10', level: '+6', type: 'bassa' }, { time: '15:28', level: '+94', type: 'alta' }, { time: '21:47', level: '-14', type: 'bassa' }, { time: '03:53', level: '+66', type: 'alta' }] },
    { day: 5, tides: [{ time: '09:48', level: '+10', type: 'bassa' }, { time: '16:06', level: '+88', type: 'alta' }, { time: '22:26', level: '-9', type: 'bassa' }, { time: '04:31', level: '+70', type: 'alta' }] },
    { day: 6, tides: [{ time: '10:27', level: '+15', type: 'bassa' }, { time: '16:45', level: '+82', type: 'alta' }, { time: '23:05', level: '-3', type: 'bassa' }, { time: '05:10', level: '+75', type: 'alta' }] }
];

function getWeatherInfo(code) {
    return weatherCodes[code] || { icon: 'üå°Ô∏è', desc: 'N/D' };
}

function getWeatherBackground(code) {
    // Sereno: 0, 1
    if (code === 0 || code === 1) return 'weather-sereno';
    // Parzialmente nuvoloso: 2
    if (code === 2) return 'weather-parziale';
    // Nuvoloso: 3, 45, 48 (nebbia)
    if (code === 3 || code === 45 || code === 48) return 'weather-nuvoloso';
    // Neve: 71, 73, 75
    if (code >= 71 && code <= 75) return 'weather-neve';
    // Temporale: 82, 95, 96, 99
    if (code === 82 || code >= 95) return 'weather-temporale';
    // Pioggia: 51-65, 80, 81
    if ((code >= 51 && code <= 65) || code === 80 || code === 81) return 'weather-pioggia';
    // Default
    return 'weather-nuvoloso';
}

function getHourlyGradient(code, hour) {
    const isNight = hour >= 21 || hour <= 5;

    if (isNight) {
        // COLORI NOTTE (testo bianco)
        // Sereno notte: 0, 1
        if (code === 0 || code === 1) return { gradient: 'linear-gradient(180deg, #1a237e 0%, #3949ab 100%)', isNight: true };
        // Parzialmente nuvoloso notte: 2
        if (code === 2) return { gradient: 'linear-gradient(180deg, #283593 0%, #5c6bc0 100%)', isNight: true };
        // Nuvoloso notte: 3, 45, 48 (nebbia)
        if (code === 3 || code === 45 || code === 48) return { gradient: 'linear-gradient(180deg, #37474f 0%, #546e7a 100%)', isNight: true };
        // Neve notte: 71, 73, 75
        if (code >= 71 && code <= 75) return { gradient: 'linear-gradient(180deg, #e8eaf6 0%, #c5cae9 100%)', isNight: false };
        // Temporale notte: 82, 95, 96, 99
        if (code === 82 || code >= 95) return { gradient: 'linear-gradient(180deg, #311b92 0%, #512da8 100%)', isNight: true };
        // Pioggia notte: 51-65, 80, 81
        if ((code >= 51 && code <= 65) || code === 80 || code === 81) return { gradient: 'linear-gradient(180deg, #0d47a1 0%, #1565c0 100%)', isNight: true };
        // Default notte
        return { gradient: 'linear-gradient(180deg, #37474f 0%, #546e7a 100%)', isNight: true };
    } else {
        // COLORI GIORNO (testo scuro)
        // Sereno: 0, 1
        if (code === 0 || code === 1) return { gradient: 'linear-gradient(180deg, #fff8e1 0%, #ffecb3 100%)', isNight: false };
        // Parzialmente nuvoloso: 2
        if (code === 2) return { gradient: 'linear-gradient(180deg, #fff8e1 0%, #e0e0e0 100%)', isNight: false };
        // Nuvoloso: 3, 45, 48 (nebbia)
        if (code === 3 || code === 45 || code === 48) return { gradient: 'linear-gradient(180deg, #f5f5f5 0%, #e0e0e0 100%)', isNight: false };
        // Neve: 71, 73, 75
        if (code >= 71 && code <= 75) return { gradient: 'linear-gradient(180deg, #fafafa 0%, #e1f5fe 100%)', isNight: false };
        // Temporale: 82, 95, 96, 99
        if (code === 82 || code >= 95) return { gradient: 'linear-gradient(180deg, #e8eaf6 0%, #5c6bc0 100%)', isNight: false };
        // Pioggia: 51-65, 80, 81
        if ((code >= 51 && code <= 65) || code === 80 || code === 81) return { gradient: 'linear-gradient(180deg, #e3f2fd 0%, #90caf9 100%)', isNight: false };
        // Default
        return { gradient: 'linear-gradient(180deg, #f5f5f5 0%, #e0e0e0 100%)', isNight: false };
    }
}

function getWeatherIcon(code, hour) {
    const isNight = hour >= 21 || hour <= 5;

    // Pioggia/Temporale: stessa icona giorno/notte
    if (code >= 95) return '‚õàÔ∏è';
    if ((code >= 51 && code <= 65) || code === 80 || code === 81 || code === 82) return 'üåßÔ∏è';
    if (code >= 71 && code <= 75) return 'üå®Ô∏è';

    // Condizioni che cambiano tra giorno e notte
    if (isNight) {
        // Notte
        if (code === 0 || code === 1) return 'üåô'; // Sereno notte
        if (code === 2) return 'üåô'; // Parz. nuvoloso notte
        if (code === 3 || code === 45 || code === 48) return '‚òÅÔ∏è'; // Nuvoloso/nebbia
        return 'üåô';
    } else {
        // Giorno
        return getWeatherInfo(code).icon;
    }
}

function getFlagStatus(weatherCode, windSpeed, waveHeight) {
    if (weatherCode >= 95 || windSpeed > 40 || waveHeight > 1.5) {
        return { color: 'red', title: 'Bandiera Rossa', desc: 'Bagno vietato', emoji: '‚õî' };
    }
    if (weatherCode >= 61 || windSpeed > 25 || waveHeight > 0.8) {
        return { color: 'yellow', title: 'Bandiera Gialla', desc: 'Bagno con cautela', emoji: '‚ö†Ô∏è' };
    }
    return { color: 'green', title: 'Bandiera Verde', desc: 'Balneazione sicura', emoji: '‚úÖ' };
}

function getSeaStatus(waveHeight) {
    if (waveHeight < 0.3) return 'Calmo';
    if (waveHeight < 0.8) return 'Poco mosso';
    if (waveHeight < 1.5) return 'Mosso';
    return 'Molto mosso';
}

function getSeaStatusSub(waveHeight) {
    if (waveHeight < 0.3) return 'Onde basse';
    if (waveHeight < 0.8) return 'Onde moderate';
    if (waveHeight < 1.5) return 'Fare attenzione';
    return 'Stare a riva';
}

function getRainForecast(hourly, currentHour) {
    // Controlla le prossime 12 ore per pioggia
    const rainCodes = [51, 53, 55, 61, 63, 65, 80, 81, 82, 95, 96, 99];

    if (!hourly || !hourly.weather_code) {
        return { willRain: false, icon: '‚òÄÔ∏è', title: 'Nessuna pioggia', sub: 'Giornata asciutta' };
    }

    for (let i = currentHour; i < Math.min(currentHour + 12, 24); i++) {
        const code = hourly.weather_code[i];
        if (rainCodes.includes(code)) {
            const hour = i.toString().padStart(2, '0') + ':00';
            if (code >= 95) {
                return { willRain: true, icon: '‚õàÔ∏è', title: 'Temporale ' + hour, sub: 'Cerca riparo' };
            } else if (code >= 61) {
                return { willRain: true, icon: 'üåßÔ∏è', title: 'Pioggia ' + hour, sub: 'Porta l\'ombrello' };
            } else {
                return { willRain: true, icon: 'üå¶Ô∏è', title: 'Pioggerella ' + hour, sub: 'Leggera pioggia' };
            }
        }
    }

    return { willRain: false, icon: '‚òÄÔ∏è', title: 'Nessuna pioggia', sub: 'Giornata asciutta' };
}

function getAdvice(flagColor, weatherCode, windSpeed) {
    // Temporale o pioggia forte
    if (weatherCode >= 95 || weatherCode === 65 || weatherCode === 82) {
        return {
            icon: '‚ö†Ô∏è',
            title: 'Temporale in arrivo',
            desc: 'Evita spiaggia e attivit√† all\'aperto. Rimani al riparo.',
            boxClass: 'danger'
        };
    }
    // Bandiera rossa
    if (flagColor === 'red') {
        return {
            icon: 'üö´',
            title: 'Bagno vietato oggi',
            desc: 'Mare pericoloso. Consigliamo musei o attivit√† al coperto.',
            boxClass: 'danger'
        };
    }
    // Vento forte
    if (windSpeed > 30) {
        return {
            icon: 'üí®',
            title: 'Giornata ventosa',
            desc: 'Attenzione in spiaggia. Ideale per kitesurf!',
            boxClass: 'warning'
        };
    }
    // Bandiera gialla
    if (flagColor === 'yellow') {
        return {
            icon: '‚ö†Ô∏è',
            title: 'Bagno con cautela',
            desc: 'Mare mosso, resta vicino alla riva. Segui i bagnini.',
            boxClass: 'warning'
        };
    }
    // Pioggia leggera
    if (weatherCode >= 51 && weatherCode <= 63) {
        return {
            icon: 'üåßÔ∏è',
            title: 'Possibili piogge',
            desc: 'Porta un ombrello. Buona giornata per visite culturali.',
            boxClass: 'warning'
        };
    }
    // Tutto ok
    return {
        icon: 'üí°',
        title: 'Giornata ideale',
        desc: 'Condizioni perfette per spiaggia, nuoto e attivit√† all\'aperto!',
        boxClass: ''
    };
}

function getNextTide() {
    const now = new Date();
    const nowMinutes = now.getHours() * 60 + now.getMinutes();

    for (let i = 0; i < tidesData.length; i++) {
        const [h, m] = tidesData[i].time.split(':').map(Number);
        const tideMinutes = h * 60 + m;
        if (tideMinutes > nowMinutes) {
            return { ...tidesData[i], index: i };
        }
    }
    return { ...tidesData[0], index: 0 };
}

function getNowPosition() {
    const now = new Date();
    return ((now.getHours() * 60 + now.getMinutes()) / 1440) * 100;
}

function openTidesModal() {
    document.getElementById('tidesModal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeTidesModal() {
    document.getElementById('tidesModal').classList.remove('active');
    document.body.style.overflow = '';
}

// Variabili globali per il modal dettaglio giorno
let cachedWeatherData = null;
let cachedMarineData = null;

function openDayModal(dayIndex) {
    if (!cachedWeatherData || !cachedMarineData) return;

    const daily = cachedWeatherData.daily;
    const hourly = cachedWeatherData.hourly || {};
    const dailyMarine = cachedMarineData.daily || {};

    const date = new Date(daily.time[dayIndex]);
    const dayLabel = dayIndex === 0 ? 'Oggi' : `${dayNamesFull[date.getDay()]} ${date.getDate()} ${monthNames[date.getMonth()]}`;
    const dayWeather = getWeatherInfo(daily.weather_code[dayIndex]);
    const tempMax = Math.round(daily.temperature_2m_max[dayIndex]);
    const tempMin = Math.round(daily.temperature_2m_min[dayIndex]);
    const waveHeight = dailyMarine.wave_height_max?.[dayIndex] || 0;
    const seaTemp = dailyMarine.sea_surface_temperature_max?.[dayIndex] || 'N/D';
    const windMax = daily.wind_speed_10m_max?.[dayIndex] || 'N/D';
    const uvMax = daily.uv_index_max?.[dayIndex] || 'N/D';
    const dayFlag = getFlagStatus(daily.weather_code[dayIndex], windMax, waveHeight);
    const rainProb = daily.precipitation_probability_max[dayIndex];
    const seaStatus = getSeaStatus(waveHeight);
    const dayTides = weeklyTidesData[dayIndex]?.tides || tidesData;

    // Orari del giorno (6, 9, 12, 15, 18, 21, 0)
    const hoursToShow = [6, 9, 12, 15, 18, 21, 0];
    const startHourIndex = dayIndex * 24;
    let hoursHtml = '';
    hoursToShow.forEach(h => {
        const idx = startHourIndex + h;
        if (hourly.temperature_2m && hourly.temperature_2m[idx] !== undefined) {
            const temp = Math.round(hourly.temperature_2m[idx]);
            const code = hourly.weather_code?.[idx] || 0;
            const icon = getWeatherIcon(code, h);
            const styleInfo = getHourlyGradient(code, h);
            const timeLabel = h === 0 ? '00:00' : `${h}:00`;
            const textColor = styleInfo.isNight ? '#ffffff' : 'var(--text-dark)';
            const timeColor = styleInfo.isNight ? 'rgba(255,255,255,0.8)' : 'var(--text-medium)';
            hoursHtml += `
                <div class="day-modal-hour" style="background: ${styleInfo.gradient};">
                    <div class="day-modal-hour-time" style="color: ${timeColor};">${timeLabel}</div>
                    <div class="day-modal-hour-icon">${icon}</div>
                    <div class="day-modal-hour-temp" style="color: ${textColor};">${temp}¬∞</div>
                </div>
            `;
        }
    });

    const adviceMap = {
        green: { icon: 'üèñÔ∏è', title: 'Giornata ideale per il mare', desc: 'Condizioni perfette per nuotare e attivit√† in spiaggia' },
        yellow: { icon: '‚ö†Ô∏è', title: 'Prestare attenzione', desc: 'Mare mosso, bagno con cautela. Meglio passeggiate' },
        red: { icon: 'üè†', title: 'Evitare il bagno', desc: 'Condizioni avverse. Consigliati musei e attivit√† indoor' }
    };
    const advice = adviceMap[dayFlag.color];

    const modalHtml = `
        <div class="day-modal-hero">
            <div class="day-modal-icon">${dayWeather.icon}</div>
            <div class="day-modal-temp">${tempMax}¬∞ / ${tempMin}¬∞</div>
            <div class="day-modal-condition">${dayWeather.desc}</div>
        </div>

        <div class="day-modal-section">
            <div class="day-modal-section-title">Previsione Oraria</div>
            <div class="day-modal-hours">
                ${hoursHtml}
            </div>
        </div>

        <div class="day-modal-section">
            <div class="day-modal-section-title">Dettagli Meteo</div>
            <div class="day-modal-details-bar">
                <span class="day-modal-detail-item"><span class="day-modal-detail-icon">üíß</span> <span class="day-modal-detail-value">${typeof seaTemp === 'number' ? Math.round(seaTemp) + '¬∞C' : seaTemp}</span> Acqua</span>
                <span class="day-modal-detail-divider">|</span>
                <span class="day-modal-detail-item"><span class="day-modal-detail-icon">üåä</span> <span class="day-modal-detail-value">${waveHeight.toFixed(1)}m</span> Onde</span>
                <span class="day-modal-detail-divider">|</span>
                <span class="day-modal-detail-item"><span class="day-modal-detail-icon">‚òî</span> <span class="day-modal-detail-value">${rainProb}%</span> Pioggia</span>
            </div>
            <div class="day-modal-details-bar">
                <span class="day-modal-detail-item"><span class="day-modal-detail-icon">üí®</span> <span class="day-modal-detail-value">${typeof windMax === 'number' ? Math.round(windMax) + 'km/h' : windMax}</span> Vento</span>
                <span class="day-modal-detail-divider">|</span>
                <span class="day-modal-detail-item"><span class="day-modal-detail-icon">‚òÄÔ∏è</span> <span class="day-modal-detail-value">${typeof uvMax === 'number' ? Math.round(uvMax) : uvMax}</span> UV</span>
                <span class="day-modal-detail-divider">|</span>
                <span class="day-modal-detail-item"><span class="flag-dot" style="background: ${dayFlag.color === 'green' ? '#4CAF50' : dayFlag.color === 'yellow' ? '#FFC107' : '#F44336'}"></span> <span class="day-modal-detail-value">${dayFlag.title}</span></span>
            </div>
        </div>

        <div class="day-modal-section">
            <div class="day-modal-section-title">Maree del Giorno</div>
            <div class="day-modal-tides-container">
                <div class="day-modal-tides">
                    ${dayTides.map(t => `
                        <div class="day-modal-tide ${t.type}">
                            <div class="day-modal-tide-time">${t.time}</div>
                            <div class="day-modal-tide-level">${t.level}cm</div>
                            <div class="day-modal-tide-type ${t.type}">${t.type === 'alta' ? '‚ñ≤ Alta' : '‚ñº Bassa'}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>

        <div class="day-modal-section">
            <div class="day-modal-section-title">Consiglio</div>
            <div class="day-modal-advice">
                <div class="day-modal-advice-icon">${advice.icon}</div>
                <div class="day-modal-advice-text">
                    <div class="day-modal-advice-title">${advice.title}</div>
                    <div class="day-modal-advice-desc">${advice.desc}</div>
                </div>
            </div>
        </div>
    `;

    document.getElementById('dayModalTitle').textContent = dayLabel;
    document.getElementById('dayModalContent').innerHTML = modalHtml;
    document.getElementById('dayModal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeDayModal() {
    document.getElementById('dayModal').classList.remove('active');
    document.body.style.overflow = '';
}

function generateWeeklyTidesHTML() {
    const today = new Date();
    let html = '';

    for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        const dayLabel = i === 0 ? 'Oggi' : `${dayNamesFull[date.getDay()]} ${date.getDate()} ${monthNames[date.getMonth()]}`;
        const dayTides = weeklyTidesData[i].tides;

        html += `
            <div class="maree-day-section">
                <div class="maree-day-title">${dayLabel}</div>
                <div class="maree-day-grid">
                    ${dayTides.map(t => `
                        <div class="maree-day-item ${t.type}">
                            <div class="maree-day-item-time">${t.time}</div>
                            <div class="maree-day-item-level">${t.level}cm</div>
                            <div class="maree-day-item-type ${t.type}">${t.type === 'alta' ? '‚ñ≤ Alta' : '‚ñº Bassa'}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    return html;
}

async function loadWeatherData() {
    try {
        const weatherUrl = 'https://api.open-meteo.com/v1/forecast?latitude=45.458&longitude=12.508&current=temperature_2m,apparent_temperature,weather_code,wind_speed_10m,relative_humidity_2m,uv_index&daily=temperature_2m_max,temperature_2m_min,weather_code,precipitation_probability_max,wind_speed_10m_max,uv_index_max&hourly=temperature_2m,weather_code&timezone=Europe/Rome&forecast_days=7';
        const marineUrl = 'https://marine-api.open-meteo.com/v1/marine?latitude=45.458&longitude=12.508&current=wave_height,sea_surface_temperature&daily=wave_height_max,sea_surface_temperature_max&timezone=Europe/Rome&forecast_days=7';

        const [weatherRes, marineRes] = await Promise.all([
            fetch(weatherUrl),
            fetch(marineUrl)
        ]);

        const weather = await weatherRes.json();
        const marine = await marineRes.json();

        renderPage(weather, marine);
    } catch (error) {
        console.error('Errore:', error);
        document.getElementById('mainContent').innerHTML = `
            <div class="loading">
                <p>Errore nel caricamento dei dati.</p>
                <p style="font-size: 12px; margin-top: 8px;">Riprova pi√π tardi.</p>
            </div>
        `;
    }
}

function renderPage(weather, marine) {
    // Cache data for day modal
    cachedWeatherData = weather;
    cachedMarineData = marine;

    const current = weather.current;
    const daily = weather.daily;
    const currentMarine = marine.current || {};
    const dailyMarine = marine.daily || {};

    const weatherInfo = getWeatherInfo(current.weather_code);
    const flag = getFlagStatus(current.weather_code, current.wind_speed_10m, currentMarine.wave_height || 0);
    const nextTide = getNextTide();
    const nowPos = getNowPosition();
    const waveHeight = currentMarine.wave_height || 0;
    const seaStatus = getSeaStatus(waveHeight);
    const seaStatusSub = getSeaStatusSub(waveHeight);

    const today = new Date();
    const rainForecast = getRainForecast(weather.hourly, today.getHours());

    const giorni = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
    const mesi = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
    const dataOggi = `${giorni[today.getDay()]} ${today.getDate()} ${mesi[today.getMonth()]}`;

    let html = `
        <!-- DATA OGGI -->
        <div class="section-title" style="margin-top: 0;">${dataOggi}</div>

        <!-- INFO CARD (identico a home) -->
        <div class="info-card ${flag.color === 'green' ? '' : flag.color}">
            <div class="info-row">
                <div class="info-item">
                    <div class="info-item-icon-wrapper">
                        <div class="info-item-dot ${flag.color}"></div>
                        <span style="font-size: 18px;">${weatherInfo.icon}</span>
                        <span style="font-size: 14px; font-weight: 600; color: var(--text-dark);">${Math.round(current.temperature_2m)}¬∞</span>
                    </div>
                    <div class="info-item-value">${flag.title}</div>
                    <div class="info-item-label">${flag.desc}</div>
                </div>
                <div class="info-divider"></div>
                <div class="info-item">
                    <div class="info-item-icon-wrapper">
                        <span class="info-item-icon">üåä</span>
                    </div>
                    <div class="info-item-value">Mare ${seaStatus}</div>
                    <div class="info-item-label">${seaStatusSub}</div>
                </div>
                <div class="info-divider"></div>
                <div class="info-item">
                    <div class="info-item-icon-wrapper">
                        <span class="info-item-icon">${rainForecast.icon}</span>
                    </div>
                    <div class="info-item-value">${rainForecast.title}</div>
                    <div class="info-item-label">${rainForecast.sub}</div>
                </div>
            </div>
        </div>

        <!-- BOX DETTAGLI -->
        <div class="meteo-details">
            <span class="meteo-detail-item"><span class="meteo-detail-icon">üí®</span> <span class="meteo-detail-value">${Math.round(current.wind_speed_10m)}km/h</span> Vento</span>
            <span class="meteo-detail-divider">|</span>
            <span class="meteo-detail-item"><span class="meteo-detail-icon">‚òÄÔ∏è</span> <span class="meteo-detail-value">${current.uv_index ? Math.round(current.uv_index) : 'N/D'}</span> UV</span>
            <span class="meteo-detail-divider">|</span>
            <span class="meteo-detail-item"><span class="meteo-detail-icon">üí¶</span> <span class="meteo-detail-value">${current.relative_humidity_2m}%</span> Umidit√†</span>
        </div>

        <!-- MAREE -->
        <div class="section-title">Maree Oggi</div>
        <div class="maree-card" onclick="openTidesModal()">
            <div class="maree-title">
                <span class="maree-title-icon">üåä</span>
                Punta Sabbioni
            </div>
            <div class="maree-boxes">
                ${tidesData.map((t, i) => `
                    <div class="maree-box ${t.type} ${i === nextTide.index ? 'next' : ''}">
                        <div class="maree-box-time">${t.time}</div>
                        <div class="maree-box-level">${t.level}cm</div>
                        <div class="maree-box-type ${t.type}">${t.type === 'alta' ? '‚ñ≤ Alta' : '‚ñº Bassa'}</div>
                    </div>
                `).join('')}
            </div>
            <div class="maree-graph">
                <div class="maree-curve">
                    <svg viewBox="0 0 100 50" preserveAspectRatio="none">
                        <path class="wave-line" d="M0,35 Q12.5,45 25,35 Q37.5,10 50,35 Q62.5,48 75,35 Q87.5,15 100,30"
                              fill="none" stroke="rgba(42,157,143,0.5)" stroke-width="2"/>
                        <path class="wave-fill" d="M0,35 Q12.5,45 25,35 Q37.5,10 50,35 Q62.5,48 75,35 Q87.5,15 100,30 L100,50 L0,50 Z"
                              fill="rgba(42,157,143,0.15)"/>
                    </svg>
                </div>
                <div class="maree-now-marker" style="left: ${nowPos}%"></div>
            </div>
            <div class="maree-next-box">
                <span class="maree-next-icon">${nextTide.type === 'alta' ? '‚ñ≤' : '‚ñº'}</span>
                <div class="maree-next-text">
                    <div class="maree-next-label">Prossima marea</div>
                    <div class="maree-next-value">${nextTide.type === 'alta' ? 'Alta' : 'Bassa'} ${nextTide.time} (${nextTide.level}cm)</div>
                </div>
            </div>
        </div>

        <!-- MODAL MAREE SETTIMANALI -->
        <div class="maree-modal-overlay" id="tidesModal" onclick="if(event.target === this) closeTidesModal()">
            <div class="maree-modal">
                <div class="maree-modal-header">
                    <div class="maree-modal-title">üåä Maree - Prossimi 7 Giorni</div>
                    <button class="maree-modal-close" onclick="closeTidesModal()">‚úï</button>
                </div>
                <div class="maree-modal-content">
                    ${generateWeeklyTidesHTML()}
                </div>
            </div>
        </div>

        <!-- FORECAST 7 GIORNI -->
        <div class="section-title">Prossimi 7 Giorni</div>
        <div class="forecast-scroll">
    `;

    for (let i = 0; i < 7; i++) {
        const date = new Date(daily.time[i]);
        const dayName = i === 0 ? 'Oggi' : dayNames[date.getDay()];
        const dayWeather = getWeatherInfo(daily.weather_code[i]);
        const waveHeight = dailyMarine.wave_height_max?.[i] || 0;
        const dayWeatherBg = getWeatherBackground(daily.weather_code[i]);
        const seaStatus = getSeaStatus(waveHeight);
        const clickHandler = i === 0 ? '' : `onclick="openDayModal(${i})"`;

        html += `
            <div class="forecast-card ${dayWeatherBg}" ${clickHandler} style="${i === 0 ? 'opacity: 0.7; cursor: default;' : ''}">
                <div class="forecast-day-name">${dayName}</div>
                <div class="forecast-icon">${dayWeather.icon}</div>
                <div class="forecast-temps-compact">
                    <span class="forecast-temp-max">${Math.round(daily.temperature_2m_max[i])}¬∞</span>
                    <span class="forecast-temp-min">/ ${Math.round(daily.temperature_2m_min[i])}¬∞</span>
                </div>
                <div class="forecast-sea">üåä ${seaStatus}</div>
            </div>
        `;
    }

    html += `</div>`;

    // Box consiglio basato sul meteo
    const adviceData = getAdvice(flag.color, current.weather_code, current.wind_speed_10m);

    html += `
        <!-- BOX CONSIGLIO -->
        <div class="advice-box ${adviceData.boxClass}">
            <div class="advice-box-icon">${adviceData.icon}</div>
            <div class="advice-box-content">
                <div class="advice-box-title">${adviceData.title}</div>
                <div class="advice-box-desc">${adviceData.desc}</div>
            </div>
        </div>

        <!-- MODAL DETTAGLIO GIORNO -->
        <div class="day-modal-overlay" id="dayModal" onclick="if(event.target === this) closeDayModal()">
            <div class="day-modal">
                <div class="day-modal-header">
                    <div class="day-modal-title" id="dayModalTitle">Dettaglio Giorno</div>
                    <button class="day-modal-close" onclick="closeDayModal()">‚úï</button>
                </div>
                <div class="day-modal-content" id="dayModalContent">
                </div>
            </div>
        </div>
    `;

    document.getElementById('mainContent').innerHTML = html;
}

document.addEventListener('DOMContentLoaded', loadWeatherData);
</script>
</body>
</html>
