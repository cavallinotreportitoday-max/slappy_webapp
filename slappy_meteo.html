<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SLAPPY ‚Äî Meteo</title>
    <style>
        :root {
            --font-system: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --radius-card: 16px;
            --radius-small: 12px;
            --bg: #f5f5f5;
            --white: #ffffff;
            --text-dark: #1a1a1a;
            --text-medium: #555555;
            --text-light: #888888;
            --teal: #2a9d8f;
            --teal-light: #b2dfdb;
            --teal-border: #b2dfdb;
            --blue-light: #b3e5fc;
            --blue-border: #bbdefb;
            --green-light: #c8e6c9;
            --green-border: #c8e6c9;
            --yellow-light: #fff59d;
            --yellow-border: #fff9c4;
            --red-light: #ffcdd2;
            --red-border: #ffcdd2;
            --purple-light: #e1bee7;
            --purple-border: #e1bee7;
            --orange-light: #ffcc80;
            --orange-border: #ffe0b2;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-900: #111827;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            font-family: var(--font-system);
            background: var(--bg);
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
        }
        .app {
            width: 100%;
            max-width: 480px;
            min-height: 100vh;
            margin: 0 auto;
            background: var(--bg);
            overflow-y: auto;
            position: relative;
        }
        @media (min-width: 481px) {
            body { display: flex; justify-content: center; background: #e8e8e8; }
            .app { box-shadow: 0 0 60px rgba(0,0,0,0.1); }
        }

        /* HEADER */
        .header {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            background: radial-gradient(ellipse at center, #3ab4a4 0%, #2a9d8f 100%);
            gap: 12px;
        }
        .header-back {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            cursor: pointer;
            border: none;
            color: white;
            font-size: 18px;
            text-decoration: none;
        }
        .header-content { flex: 1; }
        .header-title { font-size: 17px; font-weight: 700; color: white; }
        .header-subtitle { font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 2px; }

        /* MAIN */
        .main {
            padding: 16px;
            padding-bottom: 100px;
        }

        /* SECTION */
        .section-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            margin-top: 20px;
            padding: 0 4px;
        }
        .section-title:first-child { margin-top: 0; }

        /* LOADING */
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }
        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid var(--gray-200);
            border-top-color: var(--teal);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* HERO METEO */
        .hero-meteo {
            background: radial-gradient(ellipse at center, var(--white) 0%, var(--teal-light) 100%);
            border: 1px solid var(--teal-border);
            border-radius: var(--radius-card);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .hero-meteo.yellow {
            background: radial-gradient(ellipse at center, var(--white) 0%, var(--yellow-light) 100%);
            border-color: var(--yellow-border);
        }
        .hero-meteo.red {
            background: radial-gradient(ellipse at center, var(--white) 0%, var(--red-light) 100%);
            border-color: var(--red-border);
        }
        .hero-row {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .hero-icon { font-size: 56px; line-height: 1; }
        .hero-temp-block { flex: 1; }
        .hero-temp { font-size: 48px; font-weight: 700; color: var(--text-dark); line-height: 1; }
        .hero-condition { font-size: 16px; font-weight: 600; color: var(--text-dark); margin-top: 4px; }
        .hero-feels { font-size: 12px; color: var(--text-medium); margin-top: 2px; }
        .hero-right { text-align: right; }
        .hero-minmax { font-size: 13px; color: var(--text-medium); }
        .hero-date { font-size: 11px; color: var(--text-light); margin-top: 4px; }
        .hero-flag {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(0,0,0,0.06);
        }
        .flag-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .flag-dot.green { background: #4ade80; box-shadow: 0 0 8px rgba(74,222,128,0.6); }
        .flag-dot.yellow { background: #facc15; box-shadow: 0 0 8px rgba(250,204,21,0.6); }
        .flag-dot.red { background: #ef4444; box-shadow: 0 0 8px rgba(239,68,68,0.6); }
        .flag-info { flex: 1; }
        .flag-title { font-size: 14px; font-weight: 700; }
        .hero-meteo .flag-title { color: #166534; }
        .hero-meteo.yellow .flag-title { color: #854d0e; }
        .hero-meteo.red .flag-title { color: #991b1b; }
        .flag-desc { font-size: 11px; }
        .hero-meteo .flag-desc { color: #15803d; }
        .hero-meteo.yellow .flag-desc { color: #a16207; }
        .hero-meteo.red .flag-desc { color: #b91c1c; }

        /* DETTAGLI GRID */
        .details-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-card);
            padding: 16px 12px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .details-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px 8px;
        }
        .detail-item {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        .detail-icon {
            font-size: 22px;
            margin-bottom: 6px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .detail-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-dark);
            line-height: 1.2;
        }
        .detail-label { font-size: 10px; color: var(--text-light); text-transform: uppercase; margin-top: 2px; }

        /* MAREE CARD */
        .maree-card {
            background: radial-gradient(ellipse at center, var(--white) 0%, var(--blue-light) 100%);
            border: 1px solid var(--blue-border);
            border-radius: var(--radius-card);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .maree-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .maree-title-icon { font-size: 20px; }
        .maree-boxes {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        .maree-box {
            background: var(--white);
            border-radius: 12px;
            padding: 10px 6px;
            text-align: center;
            border: 1px solid rgba(59,130,246,0.2);
        }
        .maree-box.next {
            border: 2px solid #3b82f6;
            background: rgba(59,130,246,0.05);
        }
        .maree-box-time { font-size: 13px; font-weight: 700; color: var(--text-dark); }
        .maree-box-level { font-size: 11px; color: var(--text-medium); margin-top: 2px; }
        .maree-box-type { font-size: 10px; font-weight: 600; margin-top: 4px; }
        .maree-box-type.alta { color: #16a34a; }
        .maree-box-type.bassa { color: #2563eb; }

        /* GRAFICO MAREE */
        .maree-graph {
            height: 50px;
            background: linear-gradient(to bottom, rgba(59,130,246,0.05) 0%, rgba(59,130,246,0.1) 100%);
            border-radius: 10px;
            position: relative;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .maree-curve {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100%;
        }
        .maree-curve svg {
            width: 100%;
            height: 100%;
        }
        .maree-curve svg path.wave-line {
            animation: waveFloat 2.5s ease-in-out infinite;
        }
        .maree-curve svg path.wave-fill {
            animation: waveFloat 2.5s ease-in-out infinite;
        }
        @keyframes waveFloat {
            0% { transform: translateX(0) translateY(0); }
            25% { transform: translateX(-1px) translateY(-2px); }
            50% { transform: translateX(0) translateY(-3px); }
            75% { transform: translateX(1px) translateY(-2px); }
            100% { transform: translateX(0) translateY(0); }
        }
        .maree-now-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #f59e0b;
            z-index: 2;
        }
        .maree-now-marker::before {
            content: 'ORA';
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8px;
            font-weight: 700;
            color: #f59e0b;
            background: var(--white);
            padding: 2px 4px;
            border-radius: 4px;
        }
        .maree-next-box {
            background: rgba(59,130,246,0.1);
            border: 1px solid rgba(59,130,246,0.3);
            border-radius: 10px;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .maree-next-icon { font-size: 14px; }
        .maree-next-text { flex: 1; }
        .maree-next-label { font-size: 11px; color: var(--text-light); }
        .maree-next-value { font-size: 14px; font-weight: 700; color: #1e40af; }

        /* MAREE CARD CLICCABILE */
        .maree-card {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .maree-card:active {
            transform: scale(0.98);
        }
        .maree-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .maree-expand-hint {
            font-size: 11px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .maree-expand-hint span {
            font-size: 16px;
        }

        /* MODAL MAREE SETTIMANALI */
        .maree-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: flex-end;
            padding: 20px;
        }
        .maree-modal-overlay.active {
            display: flex;
        }
        .maree-modal {
            background: var(--white);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 480px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .maree-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            background: var(--white);
            z-index: 1;
        }
        .maree-modal-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-dark);
        }
        .maree-modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gray-100);
            border: none;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .maree-modal-content {
            padding: 16px 20px 20px;
        }
        .maree-day-section {
            margin-bottom: 16px;
        }
        .maree-day-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--gray-200);
        }
        .maree-day-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }
        .maree-day-item {
            background: var(--gray-100);
            border-radius: 8px;
            padding: 8px 4px;
            text-align: center;
        }
        .maree-day-item.alta {
            background: rgba(22,163,74,0.1);
        }
        .maree-day-item.bassa {
            background: rgba(37,99,235,0.1);
        }
        .maree-day-item-time {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-dark);
        }
        .maree-day-item-level {
            font-size: 10px;
            color: var(--text-medium);
            margin-top: 2px;
        }
        .maree-day-item-type {
            font-size: 9px;
            font-weight: 600;
            margin-top: 3px;
        }
        .maree-day-item-type.alta { color: #16a34a; }
        .maree-day-item-type.bassa { color: #2563eb; }

        /* FORECAST CARDS - colore basato su balneazione */
        .forecast-card {
            border-radius: var(--radius-card);
            padding: 14px 16px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .forecast-card:active {
            transform: scale(0.98);
        }
        .forecast-card.flag-green {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }
        .forecast-card.flag-yellow {
            background: #fff3cd;
            border: 1px solid #ffeeba;
        }
        .forecast-card.flag-red {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }

        /* MODAL DETTAGLIO GIORNO */
        .day-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: flex-end;
        }
        .day-modal-overlay.active {
            display: flex;
        }
        .day-modal {
            background: var(--white);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 480px;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }
        .day-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            background: var(--white);
            z-index: 1;
        }
        .day-modal-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-dark);
        }
        .day-modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gray-100);
            border: none;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .day-modal-content {
            padding: 16px 20px 20px;
        }
        .day-modal-hero {
            text-align: center;
            padding: 16px 0 20px;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 16px;
        }
        .day-modal-icon { font-size: 48px; margin-bottom: 8px; }
        .day-modal-temp { font-size: 36px; font-weight: 700; color: var(--text-dark); }
        .day-modal-condition { font-size: 14px; color: var(--text-medium); margin-top: 4px; }
        .day-modal-section {
            margin-bottom: 16px;
        }
        .day-modal-section-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        .day-modal-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .day-modal-item {
            background: var(--gray-100);
            border-radius: 10px;
            padding: 10px 8px;
            text-align: center;
        }
        .day-modal-item-icon { font-size: 18px; margin-bottom: 4px; }
        .day-modal-item-value { font-size: 13px; font-weight: 700; color: var(--text-dark); }
        .day-modal-item-label { font-size: 9px; color: var(--text-light); text-transform: uppercase; margin-top: 2px; }
        .day-modal-tides {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }
        .day-modal-tide {
            background: rgba(59,130,246,0.1);
            border-radius: 8px;
            padding: 8px 4px;
            text-align: center;
        }
        .day-modal-tide.alta { background: rgba(22,163,74,0.1); }
        .day-modal-tide.bassa { background: rgba(37,99,235,0.1); }
        .day-modal-tide-time { font-size: 12px; font-weight: 700; color: var(--text-dark); }
        .day-modal-tide-level { font-size: 10px; color: var(--text-medium); }
        .day-modal-tide-type { font-size: 9px; font-weight: 600; margin-top: 2px; }
        .day-modal-tide-type.alta { color: #16a34a; }
        .day-modal-tide-type.bassa { color: #2563eb; }
        .day-modal-advice {
            background: var(--gray-100);
            border-radius: 12px;
            padding: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .day-modal-advice-icon { font-size: 24px; }
        .day-modal-advice-text { flex: 1; }
        .day-modal-advice-title { font-size: 13px; font-weight: 700; color: var(--text-dark); }
        .day-modal-advice-desc { font-size: 11px; color: var(--text-medium); margin-top: 2px; }
        .forecast-day {
            width: 44px;
            text-align: center;
        }
        .forecast-day-name { font-size: 13px; font-weight: 700; color: var(--text-dark); }
        .forecast-day-num { font-size: 10px; color: var(--text-light); }
        .forecast-icon { font-size: 36px; width: 44px; text-align: center; }
        .forecast-temps {
            flex: 1;
            min-width: 0;
        }
        .forecast-temp-row {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-dark);
        }
        .forecast-temp-min { font-weight: 400; color: var(--text-light); font-size: 14px; }
        .forecast-details {
            display: flex;
            gap: 10px;
            margin-top: 4px;
        }
        .forecast-detail {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 11px;
            color: var(--text-medium);
        }
        .forecast-detail-icon { font-size: 12px; }

        /* TIP CARD */
        .tip-card {
            background: radial-gradient(ellipse at center, var(--white) 0%, var(--green-light) 100%);
            border: 1px solid var(--green-border);
            border-radius: var(--radius-card);
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            text-decoration: none;
            transition: transform 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .tip-card:active { transform: scale(0.98); }
        .tip-icon {
            width: 44px;
            height: 44px;
            background: #22c55e;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }
        .tip-content { flex: 1; }
        .tip-title { font-size: 14px; font-weight: 700; color: #166534; }
        .tip-desc { font-size: 12px; color: #15803d; margin-top: 2px; }
        .tip-arrow { font-size: 20px; color: #166534; }

        /* LEGENDA */
        .legenda-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-card);
            padding: 14px 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .legenda-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-light);
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        .legenda-items {
            display: flex;
            justify-content: space-around;
        }
        .legenda-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-medium);
        }
        .legenda-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .legenda-dot.green { background: #4ade80; }
        .legenda-dot.yellow { background: #facc15; }
        .legenda-dot.red { background: #ef4444; }

        /* TAB BAR MINIMAL */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            background: #f8f9fa;
            padding: 8px 16px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            display: flex;
            justify-content: space-around;
            border-top: 1px solid #e0e0e0;
            z-index: 1000;
        }
        .tab-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 6px 16px;
            cursor: pointer;
            text-decoration: none;
            position: relative;
            background: none;
            border: none;
        }
        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 3px;
            border-radius: 2px;
            background: transparent;
            transition: background 0.2s;
        }
        .tab-btn:active { opacity: 0.7; }
        .tab-btn-icon {
            font-size: 24px;
            filter: grayscale(100%);
            opacity: 0.5;
            transition: all 0.2s;
        }
        .tab-btn-label {
            font-size: 11px;
            font-weight: 500;
            color: #888888;
            transition: color 0.2s;
        }
        .tab-btn.active .tab-btn-icon { filter: grayscale(0%); opacity: 1; }
        .tab-btn.active .tab-btn-label { color: var(--text-dark); font-weight: 600; }
        .tab-btn.home.active::after { background: #78909c; }
        .tab-btn.meteo.active::after { background: #fbc02d; }
        .tab-btn.trasporti.active::after { background: #42a5f5; }
        .tab-btn.sos.active::after { background: #ef5350; }
    </style>
</head>
<body>
<div class="app">
    <header class="header">
        <a href="index.html" class="header-back">‚Üê</a>
        <div class="header-content">
            <div class="header-title">Meteo</div>
            <div class="header-subtitle">Cavallino-Treporti</div>
        </div>
    </header>

    <main class="main" id="mainContent">
        <div class="loading">
            <div class="loading-spinner"></div>
            <p style="margin-top: 12px;">Caricamento dati meteo...</p>
        </div>
    </main>

    <nav class="tab-bar">
        <a href="index.html" class="tab-btn home">
            <span class="tab-btn-icon">üè†</span>
            <span class="tab-btn-label">Home</span>
        </a>
        <a href="slappy_meteo.html" class="tab-btn meteo active">
            <span class="tab-btn-icon">üå§Ô∏è</span>
            <span class="tab-btn-label">Meteo</span>
        </a>
        <a href="slappy_trasporti.html" class="tab-btn trasporti">
            <span class="tab-btn-icon">üöå</span>
            <span class="tab-btn-label">Trasporti</span>
        </a>
        <a href="slappy_sos.html" class="tab-btn sos">
            <span class="tab-btn-icon">üÜò</span>
            <span class="tab-btn-label">SOS</span>
        </a>
    </nav>
</div>

<script>
const weatherCodes = {
    0: { icon: '‚òÄÔ∏è', desc: 'Sereno' },
    1: { icon: 'üå§Ô∏è', desc: 'Prev. sereno' },
    2: { icon: '‚õÖ', desc: 'Parz. nuvoloso' },
    3: { icon: '‚òÅÔ∏è', desc: 'Nuvoloso' },
    45: { icon: 'üå´Ô∏è', desc: 'Nebbia' },
    48: { icon: 'üå´Ô∏è', desc: 'Nebbia gelata' },
    51: { icon: 'üå¶Ô∏è', desc: 'Pioggerella' },
    53: { icon: 'üå¶Ô∏è', desc: 'Pioggerella' },
    55: { icon: 'üå¶Ô∏è', desc: 'Pioggerella' },
    61: { icon: 'üåßÔ∏è', desc: 'Pioggia leggera' },
    63: { icon: 'üåßÔ∏è', desc: 'Pioggia' },
    65: { icon: 'üåßÔ∏è', desc: 'Pioggia forte' },
    71: { icon: 'üå®Ô∏è', desc: 'Neve leggera' },
    73: { icon: 'üå®Ô∏è', desc: 'Neve' },
    75: { icon: 'üå®Ô∏è', desc: 'Neve forte' },
    80: { icon: 'üå¶Ô∏è', desc: 'Rovesci' },
    81: { icon: 'üåßÔ∏è', desc: 'Rovesci' },
    82: { icon: '‚õàÔ∏è', desc: 'Temporale' },
    95: { icon: '‚õàÔ∏è', desc: 'Temporale' },
    96: { icon: '‚õàÔ∏è', desc: 'Temporale grandine' },
    99: { icon: '‚õàÔ∏è', desc: 'Temporale grandine' }
};

const dayNames = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
const dayNamesFull = ['Domenica', 'Lunedi', 'Martedi', 'Mercoledi', 'Giovedi', 'Venerdi', 'Sabato'];
const monthNames = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];

// Maree giornaliere Punta Sabbioni (4 maree tipiche)
const tidesData = [
    { time: '06:42', level: '+12', type: 'bassa' },
    { time: '12:58', level: '+87', type: 'alta' },
    { time: '19:15', level: '-8', type: 'bassa' },
    { time: '01:24', level: '+72', type: 'alta' }
];

// Maree settimanali (simulate - in produzione usare API reale)
const weeklyTidesData = [
    { day: 0, tides: [{ time: '06:42', level: '+12', type: 'bassa' }, { time: '12:58', level: '+87', type: 'alta' }, { time: '19:15', level: '-8', type: 'bassa' }, { time: '01:24', level: '+72', type: 'alta' }] },
    { day: 1, tides: [{ time: '07:18', level: '+8', type: 'bassa' }, { time: '13:35', level: '+92', type: 'alta' }, { time: '19:52', level: '-12', type: 'bassa' }, { time: '02:01', level: '+68', type: 'alta' }] },
    { day: 2, tides: [{ time: '07:55', level: '+5', type: 'bassa' }, { time: '14:12', level: '+95', type: 'alta' }, { time: '20:30', level: '-15', type: 'bassa' }, { time: '02:38', level: '+65', type: 'alta' }] },
    { day: 3, tides: [{ time: '08:32', level: '+3', type: 'bassa' }, { time: '14:50', level: '+98', type: 'alta' }, { time: '21:08', level: '-18', type: 'bassa' }, { time: '03:15', level: '+62', type: 'alta' }] },
    { day: 4, tides: [{ time: '09:10', level: '+6', type: 'bassa' }, { time: '15:28', level: '+94', type: 'alta' }, { time: '21:47', level: '-14', type: 'bassa' }, { time: '03:53', level: '+66', type: 'alta' }] },
    { day: 5, tides: [{ time: '09:48', level: '+10', type: 'bassa' }, { time: '16:06', level: '+88', type: 'alta' }, { time: '22:26', level: '-9', type: 'bassa' }, { time: '04:31', level: '+70', type: 'alta' }] },
    { day: 6, tides: [{ time: '10:27', level: '+15', type: 'bassa' }, { time: '16:45', level: '+82', type: 'alta' }, { time: '23:05', level: '-3', type: 'bassa' }, { time: '05:10', level: '+75', type: 'alta' }] }
];

function getWeatherInfo(code) {
    return weatherCodes[code] || { icon: 'üå°Ô∏è', desc: 'N/D' };
}

function getFlagStatus(weatherCode, windSpeed, waveHeight) {
    if (weatherCode >= 95 || windSpeed > 40 || waveHeight > 1.5) {
        return { color: 'red', title: 'Bandiera Rossa', desc: 'Bagno vietato', emoji: '‚õî' };
    }
    if (weatherCode >= 61 || windSpeed > 25 || waveHeight > 0.8) {
        return { color: 'yellow', title: 'Bandiera Gialla', desc: 'Bagno con cautela', emoji: '‚ö†Ô∏è' };
    }
    return { color: 'green', title: 'Bandiera Verde', desc: 'Balneazione sicura', emoji: '‚úÖ' };
}

function getSeaStatus(waveHeight) {
    if (waveHeight < 0.3) return 'Calmo';
    if (waveHeight < 0.8) return 'Poco mosso';
    if (waveHeight < 1.5) return 'Mosso';
    return 'Molto mosso';
}

function getNextTide() {
    const now = new Date();
    const nowMinutes = now.getHours() * 60 + now.getMinutes();

    for (let i = 0; i < tidesData.length; i++) {
        const [h, m] = tidesData[i].time.split(':').map(Number);
        const tideMinutes = h * 60 + m;
        if (tideMinutes > nowMinutes) {
            return { ...tidesData[i], index: i };
        }
    }
    return { ...tidesData[0], index: 0 };
}

function getNowPosition() {
    const now = new Date();
    return ((now.getHours() * 60 + now.getMinutes()) / 1440) * 100;
}

function openTidesModal() {
    document.getElementById('tidesModal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeTidesModal() {
    document.getElementById('tidesModal').classList.remove('active');
    document.body.style.overflow = '';
}

// Variabili globali per il modal dettaglio giorno
let cachedWeatherData = null;
let cachedMarineData = null;

function openDayModal(dayIndex) {
    if (!cachedWeatherData || !cachedMarineData) return;

    const daily = cachedWeatherData.daily;
    const dailyMarine = cachedMarineData.daily || {};

    const date = new Date(daily.time[dayIndex]);
    const dayLabel = dayIndex === 0 ? 'Oggi' : `${dayNamesFull[date.getDay()]} ${date.getDate()} ${monthNames[date.getMonth()]}`;
    const dayWeather = getWeatherInfo(daily.weather_code[dayIndex]);
    const tempMax = Math.round(daily.temperature_2m_max[dayIndex]);
    const tempMin = Math.round(daily.temperature_2m_min[dayIndex]);
    const waveHeight = dailyMarine.wave_height_max?.[dayIndex] || 0;
    const dayFlag = getFlagStatus(daily.weather_code[dayIndex], 15, waveHeight);
    const rainProb = daily.precipitation_probability_max[dayIndex];
    const seaStatus = getSeaStatus(waveHeight);
    const dayTides = weeklyTidesData[dayIndex]?.tides || tidesData;

    const adviceMap = {
        green: { icon: 'üèñÔ∏è', title: 'Giornata ideale per il mare', desc: 'Condizioni perfette per nuotare e attivit√† in spiaggia' },
        yellow: { icon: '‚ö†Ô∏è', title: 'Prestare attenzione', desc: 'Mare mosso, bagno con cautela. Meglio passeggiate' },
        red: { icon: 'üè†', title: 'Evitare il bagno', desc: 'Condizioni avverse. Consigliati musei e attivit√† indoor' }
    };
    const advice = adviceMap[dayFlag.color];

    const modalHtml = `
        <div class="day-modal-hero">
            <div class="day-modal-icon">${dayWeather.icon}</div>
            <div class="day-modal-temp">${tempMax}¬∞ / ${tempMin}¬∞</div>
            <div class="day-modal-condition">${dayWeather.desc}</div>
        </div>

        <div class="day-modal-section">
            <div class="day-modal-section-title">Dettagli Meteo</div>
            <div class="day-modal-grid">
                <div class="day-modal-item">
                    <div class="day-modal-item-icon">üå°Ô∏è</div>
                    <div class="day-modal-item-value">${tempMax}¬∞</div>
                    <div class="day-modal-item-label">Max</div>
                </div>
                <div class="day-modal-item">
                    <div class="day-modal-item-icon">üå°Ô∏è</div>
                    <div class="day-modal-item-value">${tempMin}¬∞</div>
                    <div class="day-modal-item-label">Min</div>
                </div>
                <div class="day-modal-item">
                    <div class="day-modal-item-icon">‚òî</div>
                    <div class="day-modal-item-value">${rainProb}%</div>
                    <div class="day-modal-item-label">Pioggia</div>
                </div>
            </div>
        </div>

        <div class="day-modal-section">
            <div class="day-modal-section-title">Stato Mare</div>
            <div class="day-modal-grid">
                <div class="day-modal-item">
                    <div class="day-modal-item-icon">üåä</div>
                    <div class="day-modal-item-value">${waveHeight.toFixed(1)}m</div>
                    <div class="day-modal-item-label">Onde</div>
                </div>
                <div class="day-modal-item">
                    <div class="day-modal-item-icon">üèÑ</div>
                    <div class="day-modal-item-value">${seaStatus}</div>
                    <div class="day-modal-item-label">Mare</div>
                </div>
                <div class="day-modal-item" style="background: ${dayFlag.color === 'green' ? '#dcfce7' : dayFlag.color === 'yellow' ? '#fef9c3' : '#fee2e2'}">
                    <div class="day-modal-item-icon">üö©</div>
                    <div class="day-modal-item-value">${dayFlag.title.replace('Bandiera ', '')}</div>
                    <div class="day-modal-item-label">Bandiera</div>
                </div>
            </div>
        </div>

        <div class="day-modal-section">
            <div class="day-modal-section-title">Maree del Giorno</div>
            <div class="day-modal-tides">
                ${dayTides.map(t => `
                    <div class="day-modal-tide ${t.type}">
                        <div class="day-modal-tide-time">${t.time}</div>
                        <div class="day-modal-tide-level">${t.level}cm</div>
                        <div class="day-modal-tide-type ${t.type}">${t.type === 'alta' ? '‚ñ≤ Alta' : '‚ñº Bassa'}</div>
                    </div>
                `).join('')}
            </div>
        </div>

        <div class="day-modal-section">
            <div class="day-modal-section-title">Consiglio</div>
            <div class="day-modal-advice">
                <div class="day-modal-advice-icon">${advice.icon}</div>
                <div class="day-modal-advice-text">
                    <div class="day-modal-advice-title">${advice.title}</div>
                    <div class="day-modal-advice-desc">${advice.desc}</div>
                </div>
            </div>
        </div>
    `;

    document.getElementById('dayModalTitle').textContent = dayLabel;
    document.getElementById('dayModalContent').innerHTML = modalHtml;
    document.getElementById('dayModal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeDayModal() {
    document.getElementById('dayModal').classList.remove('active');
    document.body.style.overflow = '';
}

function generateWeeklyTidesHTML() {
    const today = new Date();
    let html = '';

    for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        const dayLabel = i === 0 ? 'Oggi' : `${dayNamesFull[date.getDay()]} ${date.getDate()} ${monthNames[date.getMonth()]}`;
        const dayTides = weeklyTidesData[i].tides;

        html += `
            <div class="maree-day-section">
                <div class="maree-day-title">${dayLabel}</div>
                <div class="maree-day-grid">
                    ${dayTides.map(t => `
                        <div class="maree-day-item ${t.type}">
                            <div class="maree-day-item-time">${t.time}</div>
                            <div class="maree-day-item-level">${t.level}cm</div>
                            <div class="maree-day-item-type ${t.type}">${t.type === 'alta' ? '‚ñ≤ Alta' : '‚ñº Bassa'}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    return html;
}

async function loadWeatherData() {
    try {
        const weatherUrl = 'https://api.open-meteo.com/v1/forecast?latitude=45.458&longitude=12.508&current=temperature_2m,apparent_temperature,weather_code,wind_speed_10m,relative_humidity_2m,uv_index&daily=temperature_2m_max,temperature_2m_min,weather_code,precipitation_probability_max&timezone=Europe/Rome&forecast_days=7';
        const marineUrl = 'https://marine-api.open-meteo.com/v1/marine?latitude=45.458&longitude=12.508&current=wave_height,sea_surface_temperature&daily=wave_height_max&timezone=Europe/Rome&forecast_days=7';

        const [weatherRes, marineRes] = await Promise.all([
            fetch(weatherUrl),
            fetch(marineUrl)
        ]);

        const weather = await weatherRes.json();
        const marine = await marineRes.json();

        renderPage(weather, marine);
    } catch (error) {
        console.error('Errore:', error);
        document.getElementById('mainContent').innerHTML = `
            <div class="loading">
                <p>Errore nel caricamento dei dati.</p>
                <p style="font-size: 12px; margin-top: 8px;">Riprova pi√π tardi.</p>
            </div>
        `;
    }
}

function renderPage(weather, marine) {
    // Cache data for day modal
    cachedWeatherData = weather;
    cachedMarineData = marine;

    const current = weather.current;
    const daily = weather.daily;
    const currentMarine = marine.current || {};
    const dailyMarine = marine.daily || {};

    const weatherInfo = getWeatherInfo(current.weather_code);
    const flag = getFlagStatus(current.weather_code, current.wind_speed_10m, currentMarine.wave_height || 0);
    const nextTide = getNextTide();
    const nowPos = getNowPosition();

    const today = new Date();
    const dateStr = `${dayNamesFull[today.getDay()]} ${today.getDate()} ${monthNames[today.getMonth()]}`;

    let html = `
        <!-- HERO METEO -->
        <div class="hero-meteo ${flag.color === 'green' ? '' : flag.color}">
            <div class="hero-row">
                <span class="hero-icon">${weatherInfo.icon}</span>
                <div class="hero-temp-block">
                    <div class="hero-temp">${Math.round(current.temperature_2m)}¬∞</div>
                    <div class="hero-condition">${weatherInfo.desc}</div>
                    <div class="hero-feels">Percepita ${Math.round(current.apparent_temperature)}¬∞</div>
                </div>
                <div class="hero-right">
                    <div class="hero-minmax">‚Üë ${Math.round(daily.temperature_2m_max[0])}¬∞ ‚Üì ${Math.round(daily.temperature_2m_min[0])}¬∞</div>
                    <div class="hero-date">${dateStr}</div>
                </div>
            </div>
            <div class="hero-flag">
                <div class="flag-dot ${flag.color}"></div>
                <div class="flag-info">
                    <div class="flag-title">${flag.title}</div>
                    <div class="flag-desc">${flag.desc}</div>
                </div>
            </div>
        </div>

        <!-- DETTAGLI -->
        <div class="details-card">
            <div class="details-grid">
                <div class="detail-item">
                    <div class="detail-icon">üå°Ô∏è</div>
                    <div class="detail-value">${currentMarine.sea_surface_temperature ? Math.round(currentMarine.sea_surface_temperature) + '¬∞C' : 'N/D'}</div>
                    <div class="detail-label">Acqua</div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon">üåä</div>
                    <div class="detail-value">${currentMarine.wave_height ? currentMarine.wave_height.toFixed(1) + 'm' : 'N/D'}</div>
                    <div class="detail-label">Onde</div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon">‚òî</div>
                    <div class="detail-value">${daily.precipitation_probability_max[0]}%</div>
                    <div class="detail-label">Pioggia</div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon">üí®</div>
                    <div class="detail-value">${Math.round(current.wind_speed_10m)} km/h</div>
                    <div class="detail-label">Vento</div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon">‚òÄÔ∏è</div>
                    <div class="detail-value">${Math.round(current.uv_index)}</div>
                    <div class="detail-label">UV</div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon">üíß</div>
                    <div class="detail-value">${current.relative_humidity_2m}%</div>
                    <div class="detail-label">Umidit√†</div>
                </div>
            </div>
        </div>

        <!-- MAREE -->
        <div class="section-title">Maree Oggi</div>
        <div class="maree-card" onclick="openTidesModal()">
            <div class="maree-title">
                <span class="maree-title-icon">üåä</span>
                Punta Sabbioni
            </div>
            <div class="maree-boxes">
                ${tidesData.map((t, i) => `
                    <div class="maree-box ${i === nextTide.index ? 'next' : ''}">
                        <div class="maree-box-time">${t.time}</div>
                        <div class="maree-box-level">${t.level}cm</div>
                        <div class="maree-box-type ${t.type}">${t.type === 'alta' ? '‚ñ≤ Alta' : '‚ñº Bassa'}</div>
                    </div>
                `).join('')}
            </div>
            <div class="maree-graph">
                <div class="maree-curve">
                    <svg viewBox="0 0 100 50" preserveAspectRatio="none">
                        <path class="wave-line" d="M0,35 Q12.5,45 25,35 Q37.5,10 50,35 Q62.5,48 75,35 Q87.5,15 100,30"
                              fill="none" stroke="rgba(59,130,246,0.5)" stroke-width="2"/>
                        <path class="wave-fill" d="M0,35 Q12.5,45 25,35 Q37.5,10 50,35 Q62.5,48 75,35 Q87.5,15 100,30 L100,50 L0,50 Z"
                              fill="rgba(59,130,246,0.15)"/>
                    </svg>
                </div>
                <div class="maree-now-marker" style="left: ${nowPos}%"></div>
            </div>
            <div class="maree-next-box">
                <span class="maree-next-icon">${nextTide.type === 'alta' ? '‚ñ≤' : '‚ñº'}</span>
                <div class="maree-next-text">
                    <div class="maree-next-label">Prossima marea</div>
                    <div class="maree-next-value">${nextTide.type === 'alta' ? 'Alta' : 'Bassa'} ${nextTide.time} (${nextTide.level}cm)</div>
                </div>
            </div>
        </div>

        <!-- MODAL MAREE SETTIMANALI -->
        <div class="maree-modal-overlay" id="tidesModal" onclick="if(event.target === this) closeTidesModal()">
            <div class="maree-modal">
                <div class="maree-modal-header">
                    <div class="maree-modal-title">üåä Maree - Prossimi 7 Giorni</div>
                    <button class="maree-modal-close" onclick="closeTidesModal()">‚úï</button>
                </div>
                <div class="maree-modal-content">
                    ${generateWeeklyTidesHTML()}
                </div>
            </div>
        </div>

        <!-- TIP -->
        <a href="slappy_fortini.html" class="tip-card">
            <div class="tip-icon">üö¥</div>
            <div class="tip-content">
                <div class="tip-title">${flag.color === 'green' ? 'Ideale per escursioni' : flag.color === 'yellow' ? 'Attivit√† con prudenza' : 'Meglio attivit√† indoor'}</div>
                <div class="tip-desc">${flag.color === 'green' ? 'Bici sui fortini consigliata' : flag.color === 'yellow' ? 'Controlla il meteo prima di uscire' : 'Musei o shopping consigliati'}</div>
            </div>
            <span class="tip-arrow">‚Ä∫</span>
        </a>

        <!-- FORECAST 7 GIORNI -->
        <div class="section-title">Prossimi 7 Giorni</div>
    `;

    for (let i = 0; i < 7; i++) {
        const date = new Date(daily.time[i]);
        const dayName = i === 0 ? 'Oggi' : dayNames[date.getDay()];
        const dayNum = date.getDate();
        const dayWeather = getWeatherInfo(daily.weather_code[i]);
        const waveHeight = dailyMarine.wave_height_max?.[i] || 0;
        const dayFlag = getFlagStatus(daily.weather_code[i], 15, waveHeight);
        const rainProb = daily.precipitation_probability_max[i];
        const seaStatus = getSeaStatus(waveHeight);

        html += `
            <div class="forecast-card flag-${dayFlag.color}" onclick="openDayModal(${i})">
                <div class="forecast-day">
                    <div class="forecast-day-name">${dayName}</div>
                    <div class="forecast-day-num">${dayNum} ${monthNames[date.getMonth()]}</div>
                </div>
                <div class="forecast-icon">${dayWeather.icon}</div>
                <div class="forecast-temps">
                    <div class="forecast-temp-row">
                        ${Math.round(daily.temperature_2m_max[i])}¬∞ <span class="forecast-temp-min">/ ${Math.round(daily.temperature_2m_min[i])}¬∞</span>
                    </div>
                    <div class="forecast-details">
                        <span class="forecast-detail"><span class="forecast-detail-icon">üíß</span>${rainProb}%</span>
                        <span class="forecast-detail"><span class="forecast-detail-icon">üåä</span>${seaStatus}</span>
                    </div>
                </div>
            </div>
        `;
    }

    html += `
        <!-- LEGENDA -->
        <div class="legenda-card">
            <div class="legenda-title">Legenda Balneazione</div>
            <div class="legenda-items">
                <div class="legenda-item">
                    <div class="legenda-dot green"></div>
                    <span>OK</span>
                </div>
                <div class="legenda-item">
                    <div class="legenda-dot yellow"></div>
                    <span>Attenzione</span>
                </div>
                <div class="legenda-item">
                    <div class="legenda-dot red"></div>
                    <span>Sconsigliata</span>
                </div>
            </div>
        </div>

        <!-- MODAL DETTAGLIO GIORNO -->
        <div class="day-modal-overlay" id="dayModal" onclick="if(event.target === this) closeDayModal()">
            <div class="day-modal">
                <div class="day-modal-header">
                    <div class="day-modal-title" id="dayModalTitle">Dettaglio Giorno</div>
                    <button class="day-modal-close" onclick="closeDayModal()">‚úï</button>
                </div>
                <div class="day-modal-content" id="dayModalContent">
                </div>
            </div>
        </div>
    `;

    document.getElementById('mainContent').innerHTML = html;
}

document.addEventListener('DOMContentLoaded', loadWeatherData);
</script>
</body>
</html>
